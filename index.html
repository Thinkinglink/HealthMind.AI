<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#00BFA5">
    <title>HealthMind AI</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary: #00BFA5; --primary-dark: #00897B; --primary-light: #B2DFDB;
            --secondary: #FF6B6B; --tertiary: #4ECDC4; 
            --accent: #FF69B4; --accent-dark: #E75BA0;
            --text-dark: #263238; --text-gray: #607D8B; --bg-gray: #F8F9FA;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-gray); 
            height: 100vh; 
            height: 100dvh;
            overflow: hidden; 
            position: fixed;
            width: 100%;
        }
        
        .app { 
            max-width: 480px; 
            margin: 0 auto; 
            height: 100vh; 
            height: 100dvh;
            background: white; 
            position: relative; 
            overflow: hidden; 
        }
        
        .screen { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            display: none; 
            flex-direction: column; 
            background: var(--bg-gray); 
        }
        
        .screen.active { display: flex; }

        .splash { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); justify-content: center; align-items: center; color: white; text-align: center; padding: 40px; }
        .splash-title { font-size: 48px; font-weight: 800; margin-bottom: 15px; letter-spacing: -2px; }
        .splash-subtitle { font-size: 14px; opacity: 0.9; letter-spacing: 3px; font-weight: 600; }

        .auth-screen { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
            padding: 40px 30px 120px;
            justify-content: flex-start;
            overflow-y: auto;
        }
        
        .auth-header { text-align: center; color: white; margin-bottom: 30px; padding-top: 20px; }
        .auth-content { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        .input-group input { width: 100%; padding: 15px; border: 2px solid #E0E0E0; border-radius: 12px; font-size: 16px; }
        .input-group input:focus { outline: none; border-color: var(--primary); }
        .btn-primary { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0,191,165,0.3); }
        .error { color: #E74C3C; font-size: 14px; margin-top: 5px; font-weight: 600; }
        .auth-footer { text-align: center; color: white; font-size: 15px; font-weight: 600; padding: 20px; }
        .auth-footer a { color: white; text-decoration: none; border-bottom: 2px solid white; padding-bottom: 2px; }

        .header { background: white; padding: 15px 20px; border-bottom: 1px solid #E0E0E0; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .header-title { font-size: 20px; font-weight: 700; color: var(--text-dark); }
        .header-action { position: absolute; right: 20px; background: var(--primary-light); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .header-action svg { width: 20px; height: 20px; stroke: var(--primary); stroke-width: 3; fill: none; }

        .content { flex: 1; overflow-y: auto; padding: 20px 20px 100px; -webkit-overflow-scrolling: touch; }
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .card-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; color: var(--text-dark); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding: 20px; border-radius: 15px; text-align: center; color: white; box-shadow: 0 4px 15px rgba(0,191,165,0.2); cursor: pointer; }
        .stat-value { font-size: 32px; font-weight: 800; margin-bottom: 5px; }
        .stat-label { font-size: 12px; opacity: 0.9; font-weight: 600; }
        .progress-ring-container { display: flex; justify-content: space-around; margin: 30px 0; }

        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 100%; 
            max-width: 480px; 
            background: white; 
            border-top: 1px solid #E0E0E0; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            padding: 12px 0;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); 
            z-index: 100; 
        }
        
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-gray); font-size: 11px; cursor: pointer; padding: 8px 12px; font-weight: 600; }
        .nav-item.active { color: var(--primary); }
        .nav-item svg { width: 26px; height: 26px; stroke: currentColor; stroke-width: 2.5; fill: none; }
        
        .nav-hero { 
            width: 64px; 
            height: 64px; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-top: -32px; 
            cursor: pointer; 
            box-shadow: 0 8px 24px rgba(0,191,165,0.4); 
        }
        
        .nav-hero-text { font-size: 28px; font-weight: 800; color: white; letter-spacing: -1px; }
        .nav-hero svg { width: 32px; height: 32px; fill: white; stroke: white; stroke-width: 2; }
        .nav-hero.active { box-shadow: 0 8px 24px rgba(0,191,165,0.6); }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .nav-hero.listening { animation: pulse 1.5s infinite; background: linear-gradient(135deg, var(--secondary) 0%, #E55353 100%); }
        .nav-hero.processing { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%); }
        .nav-hero.processing svg { animation: spin 1s linear infinite; }

        .workout-types { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .workout-type { background: white; border: 3px solid #E0E0E0; border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; }
        .workout-type.selected { border-color: var(--primary); background: var(--primary-light); }
        .workout-type svg { width: 48px; height: 48px; stroke: var(--text-gray); margin-bottom: 10px; }
        .workout-type.selected svg { stroke: var(--primary); }
        .workout-type-name { font-weight: 700; color: var(--text-dark); }

        .chat-messages { flex: 1; overflow-y: auto; padding: 20px 20px 100px 20px; display: flex; flex-direction: column; gap: 15px; -webkit-overflow-scrolling: touch; }
        .message { max-width: 80%; padding: 14px 18px; border-radius: 18px; line-height: 1.5; word-wrap: break-word; }
        .message.user { align-self: flex-end; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border-bottom-right-radius: 4px; }
        .message.bot { align-self: flex-start; background: white; color: var(--text-dark); border-bottom-left-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid var(--primary-light); }
        
        .chat-input-box { 
            position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px; padding: 15px 20px; background: white; 
            border-top: 1px solid #E0E0E0; display: flex !important; gap: 10px; z-index: 99;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        .chat-input { flex: 1; padding: 14px 18px; border: 2px solid #E0E0E0; border-radius: 24px; font-size: 15px; background: white; }
        .chat-input:focus { outline: none; border-color: var(--primary); }
        .send-btn { width: 50px; height: 50px; background: var(--primary); border: none; border-radius: 50%; display: flex !important; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,191,165,0.3); }
        .send-btn svg { width: 22px; height: 22px; stroke: white; fill: none; stroke-width: 2; }

        .tracking-map { width: 100%; height: 35vh; background: var(--bg-gray); position: relative; flex-shrink: 0; overflow: hidden; }
        #map-container { width: 100%; height: 100%; position: relative; }
        #map-frame { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; }
        
        .tracking-timer { font-size: 48px; font-weight: 800; text-align: center; margin: 20px 0; color: var(--primary); font-variant-numeric: tabular-nums; }
        .tracking-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 0 20px 15px; }
        .tracking-stat { text-align: center; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tracking-stat-value { font-size: 24px; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
        .tracking-stat-label { font-size: 11px; color: var(--text-gray); font-weight: 600; }
        .btn-stop, .btn-pause { margin: 0 20px 15px; padding: 16px; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; width: calc(100% - 40px); }
        .btn-stop { background: var(--secondary); box-shadow: 0 4px 15px rgba(255,107,107,0.3); }
        .btn-pause { background: var(--accent); color: white; box-shadow: 0 4px 15px rgba(255,105,180,0.3); }

        .modal { position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 24px; padding: 30px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; text-align: center; }
        .form-input { width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 10px; font-size: 15px; margin-bottom: 15px; }
        .btn-secondary { width: 100%; padding: 16px; background: white; color: var(--primary); border: 2px solid var(--primary); border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }

        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: var(--bg-gray); border-radius: 12px; margin-bottom: 10px; }
        .list-item-info { flex: 1; }
        .list-item-title { font-weight: 700; margin-bottom: 4px; }
        .list-item-subtitle { font-size: 13px; color: var(--text-gray); }
        .list-item-value { font-size: 20px; font-weight: 800; color: var(--primary); }

        .bar-chart { display: flex; align-items: flex-end; justify-content: space-between; height: 150px; gap: 8px; padding: 20px 0; }
        .bar { flex: 1; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: 8px 8px 0 0; position: relative; min-height: 20px; }
        .bar-label { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 11px; color: var(--text-gray); font-weight: 600; white-space: nowrap; }
        
        .line-chart { width: 100%; height: 150px; position: relative; margin-top: 20px; }
        .line-chart svg { width: 100%; height: 100%; }
        
        .goal-progress-bar { width: 100%; height: 12px; background: #E0E0E0; border-radius: 6px; overflow: hidden; margin-top: 10px; }
        .goal-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent) 0%, var(--accent-dark) 100%); border-radius: 6px; transition: width 0.5s ease; }
        
        .chart-legend { display: flex; gap: 20px; justify-content: center; margin-top: 10px; font-size: 13px; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; }

        .tracking-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--secondary);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            z-index: 200;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="tracking-indicator" id="tracking-indicator" style="display: none;">üèÉ TRACKING...</div>

        <div class="screen splash active" id="splash">
            <div>
                <div class="splash-title">HealthMind AI</div>
                <div class="splash-subtitle">YOUR INTELLIGENT FITNESS COMPANION</div>
            </div>
        </div>

        <div class="screen auth-screen" id="login">
            <div class="auth-header">
                <h1 style="font-size: 32px; font-weight: 700;">Welcome Back</h1>
                <p style="opacity: 0.9; margin-top: 8px;">Log in to continue your fitness journey</p>
            </div>
            <div class="auth-content">
                <div class="input-group">
                    <input type="email" id="login-email" placeholder="Email Address">
                    <div class="error" id="login-error"></div>
                </div>
                <div class="input-group">
                    <input type="password" id="login-password" placeholder="Password">
                </div>
                <button class="btn-primary" onclick="login()">Login</button>
            </div>
            <div class="auth-footer">
                Don't have an account? <a href="#" onclick="goTo('signup')">Sign Up</a>
            </div>
        </div>

        <div class="screen auth-screen" id="signup">
            <div class="auth-header">
                <h1 style="font-size: 32px; font-weight: 700;">Create Account</h1>
                <p style="opacity: 0.9; margin-top: 8px;">Start your fitness journey today</p>
            </div>
            <div class="auth-content">
                <div class="input-group">
                    <input type="text" id="signup-name" placeholder="Full Name">
                </div>
                <div class="input-group">
                    <input type="email" id="signup-email" placeholder="Email Address">
                    <div class="error" id="signup-error"></div>
                </div>
                <div class="input-group">
                    <input type="password" id="signup-password" placeholder="Password (6+ characters)">
                </div>
                <button class="btn-primary" onclick="signup()">Create Account</button>
            </div>
            <div class="auth-footer">
                Already have an account? <a href="#" onclick="goTo('login')">Log In</a>
            </div>
        </div>

        <div class="screen" id="dashboard">
            <div class="header"><div class="header-title">HealthMind AI</div></div>
            <div class="content">
                <div class="card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
                    <h3 style="font-size: 16px; opacity: 0.9; margin-bottom: 10px;">Welcome back,</h3>
                    <h2 style="font-size: 28px; font-weight: 800;" id="dash-name">User</h2>
                </div>
                <div class="card">
                    <div class="card-title">Today's Progress</div>
                    <div class="progress-ring-container">
                        <div style="text-align: center;">
                            <svg width="110" height="110">
                                <circle cx="55" cy="55" r="48" fill="none" stroke="#E0E0E0" stroke-width="10"/>
                                <circle id="steps-ring" cx="55" cy="55" r="48" fill="none" stroke="#00BFA5" stroke-width="10" stroke-dasharray="301.6" stroke-dashoffset="301.6" transform="rotate(-90 55 55)" stroke-linecap="round"/>
                                <text x="55" y="50" text-anchor="middle" font-size="20" font-weight="800" fill="#263238" id="steps-txt">0</text>
                                <text x="55" y="65" text-anchor="middle" font-size="11" fill="#607D8B">steps</text>
                            </svg>
                        </div>
                        <div style="text-align: center;">
                            <svg width="110" height="110">
                                <circle cx="55" cy="55" r="48" fill="none" stroke="#E0E0E0" stroke-width="10"/>
                                <circle id="cal-ring" cx="55" cy="55" r="48" fill="none" stroke="#FF6B6B" stroke-width="10" stroke-dasharray="301.6" stroke-dashoffset="301.6" transform="rotate(-90 55 55)" stroke-linecap="round"/>
                                <text x="55" y="50" text-anchor="middle" font-size="20" font-weight="800" fill="#263238" id="cal-txt">0</text>
                                <text x="55" y="65" text-anchor="middle" font-size="11" fill="#607D8B">kcal</text>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="dist-val">0.0</div><div class="stat-label">MILES TODAY</div></div>
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--secondary) 0%, #E55353 100%);"><div class="stat-value" id="workout-val">0</div><div class="stat-label">WORKOUTS</div></div>
                </div>
                <div class="card"><div class="card-title">Weekly Activity</div><div class="bar-chart" id="weekly-bars"></div></div>
                <div class="card">
                    <div class="card-title">Nutrition Summary</div>
                    <div class="list-item">
                        <div class="list-item-info">
                            <div class="list-item-title">Calories Remaining</div>
                            <div class="list-item-subtitle" id="dash-nutr-subtitle">Goal: 2,000 cal</div>
                        </div>
                        <div class="list-item-value" id="dash-cal-remaining">2,000</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Active Goals</div>
                    <div id="dash-goal-display">
                        <div class="list-item">
                            <div class="list-item-info">
                                <div class="list-item-title">No goals set</div>
                                <div class="list-item-subtitle">Tap Goals to set your first goal</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bottom-nav">
                <div class="nav-item active" onclick="nav(this,'dashboard')">
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none"/><path d="M12 2 L12 12 L17 7" fill="none"/><path d="M12 12 L6 15" fill="none"/></svg>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="nav(this,'workout')"><svg viewBox="0 0 24 24"><circle cx="5.5" cy="17.5" r="2.5"/><circle cx="18.5" cy="17.5" r="2.5"/><path d="M15 5l-3-3-3 3M12 2v8M9 10l3 3 3-3"/></svg><span>Workout</span></div>
                <div class="nav-hero" onclick="nav(null,'coach')"><div class="nav-hero-text">AI</div></div>
                <div class="nav-item" onclick="nav(this,'nutrition')"><svg viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg><span>Nutrition</span></div>
                <div class="nav-item" onclick="nav(this,'goals')"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Goals</span></div>
            </div>
        </div>

        <div class="screen" id="workout">
            <div class="header"><div class="header-title">Workout Tracking</div></div>
            <div id="workout-selection">
                <div style="padding: 20px; text-align: center;">
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 10px;">Choose Your Activity</h3>
                    <p style="color: var(--text-gray); font-size: 14px;">Select the type of workout</p>
                </div>
                <div class="workout-types">
                    <div class="workout-type selected" onclick="selectWorkoutType('Walking', this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2v8l3 3-3 3v6"/><circle cx="13" cy="2" r="1"/></svg>
                        <div class="workout-type-name">Walking</div>
                    </div>
                    <div class="workout-type" onclick="selectWorkoutType('Running', this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2v6l4 4-4 4v6"/><circle cx="13" cy="2" r="1"/></svg>
                        <div class="workout-type-name">Running</div>
                    </div>
                    <div class="workout-type" onclick="selectWorkoutType('Cycling', this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18.5" cy="17.5" r="3.5"/><circle cx="5.5" cy="17.5" r="3.5"/><path d="M12 17.5V14l-3-3 4-3 2 3h3"/></svg>
                        <div class="workout-type-name">Cycling</div>
                    </div>
                    <div class="workout-type" onclick="selectWorkoutType('Hiking', this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2v10l2 2-2 2v6"/><circle cx="13" cy="2" r="1"/><path d="M3 20l4-8 4 8"/></svg>
                        <div class="workout-type-name">Hiking</div>
                    </div>
                </div>
                <button class="btn-stop" style="background: var(--primary); margin-top: 20px;" onclick="startWorkout()">START WORKOUT</button>
            </div>
            <div id="workout-tracking" style="display: none; height: 100%; flex-direction: column;">
                <div class="tracking-map">
                    <div id="map-container">
                        <iframe id="map-frame" allow="geolocation"></iframe>
                        <div id="map-placeholder" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; color: var(--text-gray); position: absolute; top: 0; left: 0;">
                            <div>
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                <p style="margin-top: 10px; font-weight: 600;">Requesting GPS...</p>
                                <p style="font-size: 13px;" id="workout-type-label">Walking</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="flex: 1; overflow-y: auto;">
                    <div class="tracking-timer" id="timer">00:00:00</div>
                    <div class="tracking-stats">
                        <div class="tracking-stat"><div class="tracking-stat-value" id="t-dist">0.0</div><div class="tracking-stat-label">miles</div></div>
                        <div class="tracking-stat"><div class="tracking-stat-value" id="t-steps">0</div><div class="tracking-stat-label">Steps</div></div>
                        <div class="tracking-stat"><div class="tracking-stat-value" id="t-cal">0</div><div class="tracking-stat-label">kcal</div></div>
                    </div>
                    <button class="btn-pause" id="pause-btn" onclick="pauseWorkout()">PAUSE</button>
                    <button class="btn-stop" onclick="stopWorkout()">FINISH WORKOUT</button>
                </div>
            </div>
            <div class="bottom-nav">
                <div class="nav-item" onclick="nav(this,'dashboard')"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none"/><path d="M12 2 L12 12 L17 7" fill="none"/><path d="M12 12 L6 15" fill="none"/></svg><span>Dashboard</span></div>
                <div class="nav-item active"><svg viewBox="0 0 24 24"><circle cx="5.5" cy="17.5" r="2.5"/><circle cx="18.5" cy="17.5" r="2.5"/><path d="M15 5l-3-3-3 3M12 2v8M9 10l3 3 3-3"/></svg><span>Workout</span></div>
                <div class="nav-hero" onclick="nav(null,'coach')"><div class="nav-hero-text">AI</div></div>
                <div class="nav-item" onclick="nav(this,'nutrition')"><svg viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg><span>Nutrition</span></div>
                <div class="nav-item" onclick="nav(this,'goals')"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Goals</span></div>
            </div>
        </div>

        <div class="screen" id="coach">
            <div class="header"><div class="header-title">AI Health Coach</div></div>
            <div class="chat-messages" id="chat">
                <div class="message bot">üëã Hi! I'm your AI health coach with 50+ topics. Ask me anything about fitness, nutrition, or wellness!</div>
            </div>
            <div class="chat-input-box">
                <input type="text" class="chat-input" id="chat-input" placeholder="Ask about workouts, nutrition, motivation..." onkeypress="if(event.key==='Enter')sendMsg()">
                <button class="send-btn" onclick="sendMsg()">
                    <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
            </div>
            <div class="bottom-nav">
                <div class="nav-item" onclick="nav(this,'dashboard')"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none"/><path d="M12 2 L12 12 L17 7" fill="none"/><path d="M12 12 L6 15" fill="none"/></svg><span>Dashboard</span></div>
                <div class="nav-item" onclick="nav(this,'workout')"><svg viewBox="0 0 24 24"><circle cx="5.5" cy="17.5" r="2.5"/><circle cx="18.5" cy="17.5" r="2.5"/><path d="M15 5l-3-3-3 3M12 2v8M9 10l3 3 3-3"/></svg><span>Workout</span></div>
                <div class="nav-hero active" id="voice-btn" onclick="toggleVoice()">
                    <svg id="voice-icon" viewBox="0 0 24 24">
                        <rect x="9" y="2" width="6" height="12" rx="3" fill="white"/>
                        <path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="white" stroke-width="2" fill="none"/>
                        <line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2"/>
                        <line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2"/>
                    </svg>
                </div>
                <div class="nav-item" onclick="nav(this,'nutrition')"><svg viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg><span>Nutrition</span></div>
                <div class="nav-item" onclick="nav(this,'goals')"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Goals</span></div>
            </div>
        </div>

        <div class="screen" id="nutrition">
            <div class="header"><div class="header-title">Nutrition Log</div><div class="header-action" onclick="showModal('food')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div></div>
            <div class="content">
                <div class="card" style="background: linear-gradient(135deg, var(--tertiary) 0%, #3DB8AF 100%); color: white;">
                    <h3 style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;">Calories Remaining</h3>
                    <h2 style="font-size: 42px; font-weight: 800;" id="cal-remaining">2,000</h2>
                    <p style="opacity: 0.9; margin-top: 5px;" id="cal-subtitle">Goal: 2,000 cal</p>
                </div>
                <div class="card">
                    <div class="card-title">Today's Meals</div>
                    <div id="food-list"><p style="text-align: center; color: var(--text-gray); padding: 20px;">No meals logged yet. Tap + to add!</p></div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4ECDC4 0%, #44A89F 100%);" onclick="showModal('water')">
                        <div class="stat-value" id="water-count">0</div>
                        <div class="stat-label">OZ WATER</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #A8733F 0%, #8F6235 100%);" onclick="showModal('coffee')">
                        <div class="stat-value" id="coffee-count">0</div>
                        <div class="stat-label">OZ COFFEE</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Daily Calorie Intake</div>
                    <div class="bar-chart" id="nutr-bars"></div>
                </div>
                <div class="card">
                    <div class="card-title">Hydration Timeline</div>
                    <div class="line-chart" id="hydration-chart">
                        <svg viewBox="0 0 100 100" preserveAspectRatio="none" id="hydration-svg"></svg>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item"><div class="legend-color" style="background: #4ECDC4;"></div><span>Water</span></div>
                        <div class="legend-item"><div class="legend-color" style="background: #A8733F;"></div><span>Coffee</span></div>
                    </div>
                </div>
            </div>
            <div class="bottom-nav">
                <div class="nav-item" onclick="nav(this,'dashboard')"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none"/><path d="M12 2 L12 12 L17 7" fill="none"/><path d="M12 12 L6 15" fill="none"/></svg><span>Dashboard</span></div>
                <div class="nav-item" onclick="nav(this,'workout')"><svg viewBox="0 0 24 24"><circle cx="5.5" cy="17.5" r="2.5"/><circle cx="18.5" cy="17.5" r="2.5"/><path d="M15 5l-3-3-3 3M12 2v8M9 10l3 3 3-3"/></svg><span>Workout</span></div>
                <div class="nav-hero" onclick="nav(null,'coach')"><div class="nav-hero-text">AI</div></div>
                <div class="nav-item active"><svg viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg><span>Nutrition</span></div>
                <div class="nav-item" onclick="nav(this,'goals')"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Goals</span></div>
            </div>
        </div>

        <div class="screen" id="goals">
            <div class="header"><div class="header-title">My Goals</div><div class="header-action" onclick="showModal('goal')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div></div>
            <div class="content">
                <div class="card" style="background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%); color: white;">
                    <h3 style="font-size: 18px; margin-bottom: 8px;">üéØ Keep Going!</h3>
                    <p style="font-size: 15px; line-height: 1.6;" id="goal-motivation">You're crushing it! Every step brings you closer to your goals. Stay consistent!</p>
                </div>
                <div class="card">
                    <div class="card-title">Active Goal</div>
                    <div id="active-goal-view">
                        <div class="list-item">
                            <div class="list-item-info">
                                <div class="list-item-title">No active goal</div>
                                <div class="list-item-subtitle">Tap + to set a new goal</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card"><div class="card-title">Progress Tracker (7 Days)</div><div class="bar-chart" id="goal-bars"></div></div>
                <div class="card"><div class="card-title">Daily Targets</div><div class="list-item"><div class="list-item-info"><div class="list-item-title">Calorie Intake</div><div class="list-item-subtitle">Recommended daily</div></div><div class="list-item-value" id="target-intake">2000</div></div><div class="list-item"><div class="list-item-info"><div class="list-item-title">Calorie Burn</div><div class="list-item-subtitle">Recommended daily</div></div><div class="list-item-value" id="target-burn">500</div></div></div>
            </div>
            <div class="bottom-nav">
                <div class="nav-item" onclick="nav(this,'dashboard')"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none"/><path d="M12 2 L12 12 L17 7" fill="none"/><path d="M12 12 L6 15" fill="none"/></svg><span>Dashboard</span></div>
                <div class="nav-item" onclick="nav(this,'workout')"><svg viewBox="0 0 24 24"><circle cx="5.5" cy="17.5" r="2.5"/><circle cx="18.5" cy="17.5" r="2.5"/><path d="M15 5l-3-3-3 3M12 2v8M9 10l3 3 3-3"/></svg><span>Workout</span></div>
                <div class="nav-hero" onclick="nav(null,'coach')"><div class="nav-hero-text">AI</div></div>
                <div class="nav-item" onclick="nav(this,'nutrition')"><svg viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg><span>Nutrition</span></div>
                <div class="nav-item active"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Goals</span></div>
            </div>
        </div>

        <div class="modal" id="modal"><div class="modal-content" id="modal-body"></div></div>
    </div>

    <script>
const STATE={user:null,workouts:[],foods:[],goals:[],hydration:[],selectedWorkoutType:'Walking'};
let isRecording=false,recognition=null;
let trackTimer=null,trackStart=0,gpsWatch=null,lastPos=null,isTracking=false,isPaused=false,pausedTime=0,mapUpdateTimer=null;

function load(){const s=localStorage.getItem('hm_data');if(s){try{Object.assign(STATE,JSON.parse(s));}catch(e){}}}
function save(){try{localStorage.setItem('hm_data',JSON.stringify(STATE));}catch(e){}}

function goTo(s){
    document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
    document.getElementById(s).classList.add('active');
    if(s==='workout'){
        if(isTracking){
            document.getElementById('workout-selection').style.display='none';
            document.getElementById('workout-tracking').style.display='flex';
        }else{
            document.getElementById('workout-selection').style.display='block';
            document.getElementById('workout-tracking').style.display='none';
        }
    }
    if(s==='dashboard')updateDash();
    if(s==='goals')updateGoals();
    if(s==='nutrition')updateNutrition();
    if(s==='coach'){
        const voiceBtn=document.getElementById('voice-btn');
        voiceBtn.innerHTML='<svg id="voice-icon" viewBox="0 0 24 24"><rect x="9" y="2" width="6" height="12" rx="3" fill="white"/><path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="white" stroke-width="2" fill="none"/><line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2"/><line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2"/></svg>';
        voiceBtn.classList.remove('listening','processing');
        setTimeout(()=>{document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;},100);
    }
}

function nav(el,s){
    document.querySelectorAll('.nav-item, .nav-hero').forEach(x=>x.classList.remove('active'));
    if(el)el.classList.add('active');
    else document.querySelector('.nav-hero').classList.add('active');
    goTo(s);
}

function signup(){
    const name=document.getElementById('signup-name').value.trim();
    const email=document.getElementById('signup-email').value.trim();
    const pass=document.getElementById('signup-password').value;
    const err=document.getElementById('signup-error');
    if(!name||!email||!pass){err.textContent='Please fill all fields';return;}
    if(pass.length<6){err.textContent='Password must be 6+ characters';return;}
    if(localStorage.getItem('u_'+email)){err.textContent='Email already registered';return;}
    localStorage.setItem('u_'+email,JSON.stringify({name,email,pass}));
    alert('Account created! Please login.');
    goTo('login');
}

function login(){
    const email=document.getElementById('login-email').value.trim();
    const pass=document.getElementById('login-password').value;
    const err=document.getElementById('login-error');
    if(!email||!pass){err.textContent='Please enter email and password';return;}
    const data=localStorage.getItem('u_'+email);
    if(!data){err.textContent='Account not found';return;}
    const user=JSON.parse(data);
    if(user.pass!==pass){err.textContent='Incorrect password';return;}
    STATE.user=user;save();goTo('dashboard');
}

function updateDash(){
    if(!STATE.user)return;
    document.getElementById('dash-name').textContent=STATE.user.name.split(' ')[0];
    let steps=0,dist=0,cal=0;
    STATE.workouts.forEach(w=>{steps+=w.steps||0;dist+=w.distance||0;cal+=w.calories||0;});
    if(isTracking && STATE.tracking){steps+=STATE.tracking.steps||0;dist+=STATE.tracking.distance||0;cal+=STATE.tracking.calories||0;}
    document.getElementById('dist-val').textContent=dist.toFixed(1);
    document.getElementById('workout-val').textContent=STATE.workouts.length;
    const circ=301.6;
    document.getElementById('steps-ring').style.strokeDashoffset=circ-(Math.min(steps/10000,1)*circ);
    document.getElementById('steps-txt').textContent=steps.toLocaleString();
    document.getElementById('cal-ring').style.strokeDashoffset=circ-(Math.min(cal/500,1)*circ);
    document.getElementById('cal-txt').textContent=Math.floor(cal);
    const bars=document.getElementById('weekly-bars');
    bars.innerHTML='';
    [40,60,30,80,50,90,70].forEach((h,i)=>{
        const bar=document.createElement('div');
        bar.className='bar';
        bar.style.height=h+'%';
        const lbl=document.createElement('div');
        lbl.className='bar-label';
        lbl.textContent=['M','T','W','T','F','S','S'][i];
        bar.appendChild(lbl);
        bars.appendChild(bar);
    });
    let totalCal=0;
    if(STATE.foods)STATE.foods.forEach(f=>totalCal+=f.calories||0);
    const goal=2000;
    const remaining=goal-totalCal+cal;
    document.getElementById('dash-cal-remaining').textContent=Math.max(0,Math.round(remaining));
    document.getElementById('dash-nutr-subtitle').textContent=`Eaten: ${totalCal} cal | Burned: ${Math.round(cal)} cal`;
    const goalDisplay=document.getElementById('dash-goal-display');
    if(STATE.goals && STATE.goals.length>0){
        const g=STATE.goals[0];
        const elapsed=Math.floor((Date.now()-new Date(g.created).getTime())/(1000*60*60*24));
        const remaining=Math.max(0,g.days-elapsed);
        const progress=Math.min(100,(elapsed/g.days)*100);
        goalDisplay.innerHTML=`<div class="list-item"><div class="list-item-info"><div class="list-item-title">${g.title}</div><div class="list-item-subtitle">${remaining} days remaining</div></div><div class="list-item-value">${Math.round(progress)}%</div></div>`;
    }else{
        goalDisplay.innerHTML='<div class="list-item"><div class="list-item-info"><div class="list-item-title">No goals set</div><div class="list-item-subtitle">Tap Goals to set your first goal</div></div></div>';
    }
}

function selectWorkoutType(type,el){
    STATE.selectedWorkoutType=type;
    document.querySelectorAll('.workout-type').forEach(x=>x.classList.remove('selected'));
    el.classList.add('selected');
}

function startWorkout(){
    if(isTracking)return;
    STATE.tracking={type:STATE.selectedWorkoutType,start:Date.now(),distance:0,steps:0,calories:0,speeds:[]};
    isTracking=true;
    isPaused=false;
    document.getElementById('tracking-indicator').style.display='block';
    document.getElementById('workout-selection').style.display='none';
    document.getElementById('workout-tracking').style.display='flex';
    document.getElementById('workout-type-label').textContent=STATE.selectedWorkoutType;
    trackStart=Date.now();
    trackTimer=setInterval(()=>{updateTimer();updateTrackDisplay();updateDash();},1000);
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
            pos=>{
                lastPos={lat:pos.coords.latitude,lon:pos.coords.longitude,time:Date.now(),alt:pos.coords.altitude||0};
                updateMapSmooth(lastPos.lat,lastPos.lon);
                gpsWatch=navigator.geolocation.watchPosition(
                    pos=>{
                        if(!isPaused){
                            const curr={lat:pos.coords.latitude,lon:pos.coords.longitude,time:Date.now(),alt:pos.coords.altitude||0};
                            if(lastPos){
                                const d=dist(lastPos.lat,lastPos.lon,curr.lat,curr.lon);
                                const timeDiff=(curr.time-lastPos.time)/1000;
                                const speed=timeDiff>0?(d/timeDiff)*3600:0;
                                STATE.tracking.distance+=d;
                                STATE.tracking.speeds.push(speed);
                                if(STATE.selectedWorkoutType==='Walking'){
                                    STATE.tracking.steps+=Math.floor(d*1315);
                                    STATE.tracking.calories+=d*65;
                                }else if(STATE.selectedWorkoutType==='Running'){
                                    STATE.tracking.steps+=Math.floor(d*1570);
                                    STATE.tracking.calories+=d*100;
                                }else if(STATE.selectedWorkoutType==='Cycling'){
                                    const avgSpeed=STATE.tracking.speeds.reduce((a,b)=>a+b,0)/STATE.tracking.speeds.length;
                                    STATE.tracking.calories+=d*40*Math.max(1,avgSpeed/15);
                                }else if(STATE.selectedWorkoutType==='Hiking'){
                                    const altGain=Math.max(0,curr.alt-lastPos.alt);
                                    STATE.tracking.steps+=Math.floor(d*1315);
                                    STATE.tracking.calories+=d*70+altGain*0.05;
                                }
                            }
                            lastPos=curr;
                            updateMapSmooth(curr.lat,curr.lon);
                        }
                    },
                    err=>console.error('GPS:',err),
                    {enableHighAccuracy:true,timeout:10000,maximumAge:0}
                );
            },
            err=>{alert('Please enable GPS');}
        );
    }
}

function updateMapSmooth(lat,lon){
    if(mapUpdateTimer)clearTimeout(mapUpdateTimer);
    mapUpdateTimer=setTimeout(()=>{
        const mapFrame=document.getElementById('map-frame');
        const mapPlaceholder=document.getElementById('map-placeholder');
        mapFrame.src=`https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.005},${lat-0.005},${lon+0.005},${lat+0.005}&layer=mapnik&marker=${lat},${lon}`;
        mapFrame.style.display='block';
        mapPlaceholder.style.display='none';
    },2000);
}

function pauseWorkout(){
    const btn=document.getElementById('pause-btn');
    if(!isPaused){
        isPaused=true;
        pausedTime=Date.now();
        clearInterval(trackTimer);
        btn.textContent='RESUME';
        btn.style.background='var(--primary)';
    }else{
        isPaused=false;
        trackStart+=(Date.now()-pausedTime);
        trackTimer=setInterval(()=>{updateTimer();updateTrackDisplay();updateDash();},1000);
        btn.textContent='PAUSE';
        btn.style.background='var(--accent)';
        btn.style.color='white';
    }
}

function stopWorkout(){
    if(!isTracking)return;
    clearInterval(trackTimer);
    if(gpsWatch)navigator.geolocation.clearWatch(gpsWatch);
    if(mapUpdateTimer)clearTimeout(mapUpdateTimer);
    document.getElementById('tracking-indicator').style.display='none';
    STATE.workouts.push({
        type:STATE.selectedWorkoutType,
        date:new Date().toISOString(),
        distance:STATE.tracking.distance,
        steps:Math.floor(STATE.tracking.steps),
        calories:Math.floor(STATE.tracking.calories)
    });
    STATE.tracking=null;
    lastPos=null;
    isTracking=false;
    isPaused=false;
    document.getElementById('workout-selection').style.display='block';
    document.getElementById('workout-tracking').style.display='none';
    document.getElementById('timer').textContent='00:00:00';
    document.getElementById('t-dist').textContent='0.0';
    document.getElementById('t-steps').textContent='0';
    document.getElementById('t-cal').textContent='0';
    const mapFrame=document.getElementById('map-frame');
    mapFrame.style.display='none';
    document.getElementById('map-placeholder').style.display='flex';
    mapFrame.src='';
    const btn=document.getElementById('pause-btn');
    btn.textContent='PAUSE';
    btn.style.background='var(--accent)';
    btn.style.color='white';
    save();
    const last=STATE.workouts[STATE.workouts.length-1];
    alert(`Workout saved!\nDistance: ${last.distance.toFixed(2)}km\nSteps: ${last.steps}\nCalories: ${last.calories}`);
    nav(document.querySelector('.nav-item'),'dashboard');
}

function updateTimer(){
    if(!isTracking)return;
    const e=Math.floor((Date.now()-trackStart)/1000);
    const h=Math.floor(e/3600);
    const m=Math.floor((e%3600)/60);
    const s=e%60;
    document.getElementById('timer').textContent=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

function updateTrackDisplay(){
    if(!STATE.tracking)return;
    document.getElementById('t-dist').textContent=STATE.tracking.distance.toFixed(2);
    document.getElementById('t-steps').textContent=Math.floor(STATE.tracking.steps).toLocaleString();
    document.getElementById('t-cal').textContent=Math.floor(STATE.tracking.calories);
}

function dist(lat1,lon1,lat2,lon2){
    const R=6371;
    const dLat=(lat2-lat1)*Math.PI/180;
    const dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function showModal(type){
    const modal=document.getElementById('modal');
    const body=document.getElementById('modal-body');
    if(type==='food'){
        body.innerHTML=`<div class="modal-title">Add Food</div><input class="form-input" id="m-food-name" placeholder="Food name"><input class="form-input" id="m-food-cal" type="number" placeholder="Calories"><button class="btn-primary" onclick="addFood()">Log Food</button><button class="btn-secondary" onclick="closeModal()">Cancel</button>`;
    }else if(type==='water'){
        body.innerHTML=`<div class="modal-title">Add Water</div><input class="form-input" id="m-water-oz" type="number" placeholder="Ounces"><button class="btn-primary" onclick="addHydration('water')">Log Water</button><button class="btn-secondary" onclick="closeModal()">Cancel</button>`;
    }else if(type==='coffee'){
        body.innerHTML=`<div class="modal-title">Add Coffee</div><input class="form-input" id="m-coffee-oz" type="number" placeholder="Ounces"><button class="btn-primary" onclick="addHydration('coffee')">Log Coffee</button><button class="btn-secondary" onclick="closeModal()">Cancel</button>`;
    }else if(type==='goal'){
        body.innerHTML=`<div class="modal-title">Set Weight Loss Goal</div><input class="form-input" id="m-goal-current" type="number" placeholder="Current weight (lbs)" step="0.1"><input class="form-input" id="m-goal-target" type="number" placeholder="Target weight (lbs)" step="0.1"><input class="form-input" id="m-goal-days" type="number" placeholder="Days to achieve"><button class="btn-primary" onclick="addGoal()">Set Goal</button><button class="btn-secondary" onclick="closeModal()">Cancel</button>`;
    }
    modal.classList.add('active');
}

function closeModal(){document.getElementById('modal').classList.remove('active');}

function addFood(){
    const name=document.getElementById('m-food-name').value.trim();
    const cal=parseInt(document.getElementById('m-food-cal').value);
    if(!name||!cal){alert('Please fill all fields');return;}
    if(!STATE.foods)STATE.foods=[];
    STATE.foods.push({name,calories:cal,time:new Date().toLocaleTimeString()});
    save();closeModal();updateNutrition();updateDash();
    alert(`${name} logged!`);
}

function addHydration(type){
    const ozInput=type==='water'?document.getElementById('m-water-oz'):document.getElementById('m-coffee-oz');
    const oz=parseInt(ozInput.value);
    if(!oz||oz<=0){alert('Please enter ounces');return;}
    if(!STATE.hydration)STATE.hydration=[];
    STATE.hydration.push({type,oz,time:new Date().toLocaleTimeString(),hour:new Date().getHours()});
    save();closeModal();updateNutrition();
    alert(`${oz}oz ${type} logged!`);
}

function addGoal(){
    const current=parseFloat(document.getElementById('m-goal-current').value);
    const target=parseFloat(document.getElementById('m-goal-target').value);
    const days=parseInt(document.getElementById('m-goal-days').value);
    if(!current||!target||!days){alert('Please fill all fields');return;}
    if(current<=target){alert('Current must be higher than target');return;}
    if(days<7){alert('Minimum 7 days');return;}
    const diff=current-target;
    const dailyCal=Math.ceil((diff*3500)/days);
    STATE.goals=[{title:`Lose ${diff.toFixed(1)} lbs`,current,target,days,dailyCalDeficit:dailyCal,created:new Date().toISOString()}];
    document.getElementById('target-intake').textContent=Math.max(1200,2000-dailyCal);
    document.getElementById('target-burn').textContent=dailyCal;
    save();closeModal();updateGoals();updateDash();
    alert(`Goal set!`);
}

function updateNutrition(){
    const foodList=document.getElementById('food-list');
    if(STATE.foods && STATE.foods.length>0){
        foodList.innerHTML=STATE.foods.map(f=>`<div class="list-item"><div class="list-item-info"><div class="list-item-title">${f.name}</div><div class="list-item-subtitle">${f.time}</div></div><div class="list-item-value">${f.calories}</div></div>`).join('');
    }else{
        foodList.innerHTML='<p style="text-align: center; color: var(--text-gray); padding: 20px;">No meals logged yet. Tap + to add!</p>';
    }
    let totalCal=0;
    if(STATE.foods)STATE.foods.forEach(f=>totalCal+=f.calories||0);
    let burned=0;
    STATE.workouts.forEach(w=>burned+=w.calories||0);
    if(isTracking&&STATE.tracking)burned+=STATE.tracking.calories||0;
    const goal=2000;
    const remaining=goal-totalCal+burned;
    document.getElementById('cal-remaining').textContent=Math.max(0,Math.round(remaining));
    document.getElementById('cal-subtitle').textContent=`Eaten: ${totalCal} cal | Burned: ${Math.round(burned)} cal`;
    let waterOz=0,coffeeOz=0;
    if(STATE.hydration){STATE.hydration.forEach(h=>{if(h.type==='water')waterOz+=h.oz||0;else coffeeOz+=h.oz||0;});}
    document.getElementById('water-count').textContent=waterOz;
    document.getElementById('coffee-count').textContent=coffeeOz;
    const nutrBars=document.getElementById('nutr-bars');
    nutrBars.innerHTML='';
    [1200,1800,1500,2100,1900,2200,totalCal||500].forEach((cal,i)=>{
        const bar=document.createElement('div');
        bar.className='bar';
        bar.style.height=Math.min(100,(cal/2500)*100)+'%';
        bar.style.background='linear-gradient(180deg, #4ECDC4 0%, #44A89F 100%)';
        const lbl=document.createElement('div');
        lbl.className='bar-label';
        lbl.textContent=i===6?`Today\n${cal}cal`:['Mon','Tue','Wed','Thu','Fri','Sat'][i];
        bar.appendChild(lbl);
        nutrBars.appendChild(bar);
    });
    drawHydrationChart();
}

function drawHydrationChart(){
    const svg=document.getElementById('hydration-svg');
    if(!STATE.hydration||STATE.hydration.length===0){
        svg.innerHTML='<text x="50" y="50" text-anchor="middle" fill="#607D8B" font-size="8">No hydration data yet</text>';
        return;
    }
    const hourlyData={};
    for(let h=0;h<24;h++)hourlyData[h]={water:0,coffee:0};
    STATE.hydration.forEach(h=>{if(hourlyData[h.hour])hourlyData[h.hour][h.type]+=h.oz||0;});
    const maxOz=Math.max(...Object.values(hourlyData).map(d=>d.water+d.coffee),1);
    let waterPath='M 0,100',coffeePath='M 0,100';
    Object.keys(hourlyData).forEach((hour,i)=>{
        const x=(i/23)*100;
        const waterY=100-((hourlyData[hour].water/maxOz)*80);
        const coffeeY=100-((hourlyData[hour].coffee/maxOz)*80);
        waterPath+=` L ${x},${waterY}`;
        coffeePath+=` L ${x},${coffeeY}`;
    });
    waterPath+=' L 100,100 Z';
    coffeePath+=' L 100,100 Z';
    svg.innerHTML=`<path d="${waterPath}" fill="rgba(78,205,196,0.3)" stroke="#4ECDC4" stroke-width="1"/><path d="${coffeePath}" fill="rgba(168,115,63,0.3)" stroke="#A8733F" stroke-width="1"/><line x1="0" y1="100" x2="100" y2="100" stroke="#E0E0E0" stroke-width="0.5"/><text x="2" y="15" font-size="6" fill="#607D8B">${Math.round(maxOz)}oz</text>`;
}

function updateGoals(){
    const msgs=['You\'re unstoppable!','Amazing dedication!','Every step counts!','Crushing your goals!','Your hard work is paying off!'];
    document.getElementById('goal-motivation').textContent=msgs[Math.floor(Math.random()*msgs.length)];
    const goalView=document.getElementById('active-goal-view');
    if(STATE.goals && STATE.goals.length>0){
        const g=STATE.goals[0];
        const elapsed=Math.floor((Date.now()-new Date(g.created).getTime())/(1000*60*60*24));
        const remaining=Math.max(0,g.days-elapsed);
        const progress=Math.min(100,(elapsed/g.days)*100);
        goalView.innerHTML=`<div class="list-item"><div class="list-item-info"><div class="list-item-title">${g.title}</div><div class="list-item-subtitle">${remaining} days left of ${g.days} total</div></div><div class="list-item-value">${Math.round(progress)}%</div></div><div class="goal-progress-bar"><div class="goal-progress-fill" style="width: ${progress}%"></div></div>`;
    }else{
        goalView.innerHTML='<div class="list-item"><div class="list-item-info"><div class="list-item-title">No active goal</div><div class="list-item-subtitle">Tap + to set a new goal</div></div></div>';
    }
    const bars=document.getElementById('goal-bars');
    bars.innerHTML='';
    [20,35,50,65,75,85,95].forEach((progress,i)=>{
        const bar=document.createElement('div');
        bar.className='bar';
        bar.style.height=progress+'%';
        bar.style.background='linear-gradient(180deg, var(--accent) 0%, var(--accent-dark) 100%)';
        const lbl=document.createElement('div');
        lbl.className='bar-label';
        lbl.textContent=`Day ${i+1}\n${progress}%`;
        bar.appendChild(lbl);
        bars.appendChild(bar);
    });
}

function toggleVoice(){
    const voiceBtn=document.getElementById('voice-btn');
    if(isRecording){stopRecording();return;}
    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
        if(!recognition){
            recognition=new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous=false;
            recognition.interimResults=false;
            recognition.lang='en-US';
            recognition.onresult=async e=>{
                const transcript=e.results[0][0].transcript;
                addUserMessage(transcript);
                voiceBtn.classList.remove('listening');
                voiceBtn.classList.add('processing');
                voiceBtn.innerHTML='<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="white" stroke-width="4" fill="none" stroke-dasharray="31.4 31.4" style="animation: spin 1s linear infinite;"/></svg>';
                const reply=await getAIReply(transcript);
                addBotMessage(reply);
                speakReply(reply);
            };
            recognition.onend=()=>{
                isRecording=false;
                voiceBtn.classList.remove('listening','processing');
                voiceBtn.innerHTML='<svg id="voice-icon" viewBox="0 0 24 24"><rect x="9" y="2" width="6" height="12" rx="3" fill="white"/><path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="white" stroke-width="2" fill="none"/><line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2"/><line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2"/></svg>';
            };
            recognition.onerror=e=>{
                console.error('Speech:',e.error);
                isRecording=false;
                voiceBtn.classList.remove('listening','processing');
                voiceBtn.innerHTML='<svg id="voice-icon" viewBox="0 0 24 24"><rect x="9" y="2" width="6" height="12" rx="3" fill="white"/><path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="white" stroke-width="2" fill="none"/><line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2"/><line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2"/></svg>';
                addBotMessage("Sorry, couldn't hear that. Please try again or type!");
            };
        }
        startRecording();
    }else{
        alert('Voice not supported. Please type!');
    }
}

function startRecording(){
    const voiceBtn=document.getElementById('voice-btn');
    isRecording=true;
    voiceBtn.classList.add('listening');
    voiceBtn.innerHTML='<svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2" fill="white"/></svg>';
    recognition.start();
}

function stopRecording(){
    isRecording=false;
    if(recognition)recognition.stop();
}

function speakReply(text){
    const voiceBtn=document.getElementById('voice-btn');
    if('speechSynthesis' in window){
        const utterance=new SpeechSynthesisUtterance(text);
        utterance.onend=()=>{
            voiceBtn.classList.remove('processing');
            voiceBtn.innerHTML='<svg id="voice-icon" viewBox="0 0 24 24"><rect x="9" y="2" width="6" height="12" rx="3" fill="white"/><path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="white" stroke-width="2" fill="none"/><line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2"/><line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2"/></svg>';
        };
        speechSynthesis.speak(utterance);
    }else{
        voiceBtn.classList.remove('processing');
        voiceBtn.innerHTML='<svg id="voice-icon" viewBox="0 0 24 24"><rect x="9" y="2" width="6" height="12" rx="3" fill="white"/><path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="white" stroke-width="2" fill="none"/><line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2"/><line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2"/></svg>';
    }
}

function addUserMessage(msg){
    const chat=document.getElementById('chat');
    chat.innerHTML+=`<div class="message user">${msg}</div>`;
    chat.scrollTop=chat.scrollHeight;
}

function addBotMessage(msg){
    const chat=document.getElementById('chat');
    chat.innerHTML+=`<div class="message bot">${msg}</div>`;
    chat.scrollTop=chat.scrollHeight;
}

const AI={"lose weight":"Create a 300-500 cal daily deficit. Cardio 3-4x/week + strength training 2-3x/week. Track food. Aim 1-2 lbs loss weekly.","build muscle":"Eat 0.8-1g protein per lb bodyweight. Lift heavy 3-4x/week with progressive overload. Sleep 7-9 hours.","protein":"0.8-1g per lb bodyweight. Sources: chicken, fish, eggs, Greek yogurt, beans, tofu. Spread throughout day.","water":"Half your bodyweight in ounces daily. Add 16-20oz per hour exercise. Dark urine = need more.","workout":"Beginners: 3-4x/week full body. Intermediate: 4-5x/week split. Include warm-up, workout, cool-down.","cardio":"Mix steady-state (30-45min) or HIIT (15-20min). 3-5x/week after weights or separate days.","rest":"Crucial! Muscles grow during rest. Take 1-2 full rest days weekly. Light activity OK.","motivated":"Set SMART goals. Track with photos/measurements. Find buddy. Remember your WHY!","diet":"Whole foods: lean proteins, fruits, veggies, whole grains, healthy fats. 80/20 rule.","sleep":"7-9 hours nightly. Recovery and hormones happen here. Poor sleep = poor results.","beginner":"3x/week full body + 20-30min cardio 2-3x/week. Learn form. Track nutrition. Be patient!","abs":"Made in kitchen! Core 2-3x/week: planks, twists, leg raises, crunches. Daily not needed.","stretch":"Dynamic before workouts. Static after (hold 30sec). Improves flexibility, reduces injury.","strength":"Compound first: squats, deadlifts, bench, rows. Then isolation. 3-4 sets, 8-12 reps.","running":"Start slow! Walk-run program, focus form, good shoes, increase 10% weekly max.","cycling":"Adjust bike fit. Start 20-30min easy. Build endurance before intensity.","walking":"Great low-impact! 30-60min most days. Swing arms, good posture, comfortable pace.","hiking":"Build endurance first. Proper footwear essential. Bring water. Start easy trails.","calories":"Calculate TDEE. Loss: TDEE-500. Maintenance: TDEE. Gain: TDEE+300-500.","carbs":"Fuel workouts! Complex: oats, brown rice, quinoa, sweet potato. Eat around workouts.","fat":"Essential! Avocados, nuts, olive oil, fatty fish. 20-30% total calories.","meal prep":"Sundays! Cook bulk proteins, chop veggies, portion meals. Use containers. Freeze extras.","supplements":"Helpful: Protein powder, Creatine (5g daily), Vitamin D, Omega-3. Food first!","creatine":"Safest! 5g daily improves strength and muscle. Stay hydrated.","injury":"Stop if pain! RICE: Rest, Ice, Compression, Elevation. See doctor if persists.","sore":"DOMS normal! Peaks 24-48hrs. Ease with movement, stretching, foam rolling, protein.","plateau":"Increase intensity, change routine, recalculate calories, check portions.","recovery":"When adaptation happens! Sleep, nutrition, hydration, active recovery, stretching.","consistency":"Key! Better 30min 4x/week than 2hr once. Build habits. Small actions = big results.","motivation":"Comes and goes - build discipline! Routine, schedule workouts, celebrate wins.","stress":"Exercise reduces stress! Releases endorphins. Also: meditation, yoga, breathing.","gym":"First visit: Tour, start machines, learn 5-6 exercises, don't compare, ask staff.","home":"No gym? Bodyweight: push-ups, squats, lunges, planks, burpees. Add bands, dumbbells.","equipment":"Minimal: bands ($20), dumbbells ($100-200), mat ($20). Enough!","track":"Track everything! Workouts, food, measurements. Data = progress.","progress":"Multiple ways: photos, measurements, clothes fit, strength, energy levels.","age":"Never too old! Start slow, focus form, listen body. Strength important for aging.","woman":"Lift weights! Won't get bulky. Benefits: strength, bones, metabolism!","form":"Form over weight ALWAYS! Bad form = injury. Start light, master movement.","nutrition":"70-80% of results! Can't out-train bad diet. Focus nutrient-dense foods.","hydration":"Improves performance, aids recovery, regulates temperature. Sip throughout day.","flexibility":"Enhances performance, reduces injury. Add yoga/mobility 2-3x/week.","core":"Improves posture, balance, strength! Planks, dead bugs, bird dogs, pallof presses.","hiit":"20-30sec max, 60-90sec rest. Repeat 8-10x. Fat loss. 2-3x/week max!","morning":"Great! Fasted or light snack. Benefits: consistency, energy. Eat protein after.","evening":"Works too! May be stronger. Eat 1-2hrs before. May affect sleep - test it.","food":"Nourish body, align goals. Prioritize proteins, complex carbs, healthy fats, veggies.","weight loss":"Consistency over perfection! Balanced nutrition + exercise + sleep + hydration.","muscle":"Grow during rest! Eat protein, lift consistently, adequate recovery.","exercise":"Consistency trumps intensity! Better moderate regularly than intense sporadically.","how":"Start today! Set one goal, schedule workout, clean foods, take photos.","when":"Best time is when you'll actually do it! Some prefer mornings, others evenings.","start":"Hardest part is starting! Begin where you are, use what you have."};
const FALLBACKS=["That's interesting! I specialize in fitness, nutrition, weight loss, muscle building, workouts, recovery, motivation. Could you rephrase?","Great question! While I'm focused on fitness, I'd love to help! Ask about workouts, nutrition, supplements, recovery, motivation.","I'm here for your fitness journey! Try 'how to lose weight', 'build muscle', 'meal prep', 'workout routines', 'staying motivated'.","Interesting! What about: weight loss, muscle building, nutrition, workout programming, recovery?","I'm your AI fitness coach! I help with exercise, nutrition, supplements, injury prevention, motivation. What interests you?"];

async function getAIReply(msg){
    let reply='';
    if('ai' in self && 'languageModel' in self.ai){
        try{
            const capabilities=await self.ai.languageModel.capabilities();
            if(capabilities && capabilities.available==='readily'){
                const session=await self.ai.languageModel.create({systemPrompt:"You are an enthusiastic fitness coach. Give practical advice in 2-3 sentences. Be encouraging!"});
                reply=await session.prompt(msg);
                session.destroy();
            }
        }catch(e){}
    }
    if(!reply){
        const m=msg.toLowerCase();
        for(let key in AI){if(m.includes(key)){reply=AI[key];break;}}
        if(!reply)reply=FALLBACKS[Math.floor(Math.random()*FALLBACKS.length)];
    }
    return reply;
}

async function sendMsg(){
    const input=document.getElementById('chat-input');
    const msg=input.value.trim();
    if(!msg)return;
    addUserMessage(msg);
    input.value='';
    const reply=await getAIReply(msg);
    addBotMessage(reply);
}

document.addEventListener('DOMContentLoaded',()=>{
    load();
    setTimeout(()=>{goTo(STATE.user?'dashboard':'login');},2000);
});
    </script>
</body>
</html>
